---
title: "Compilation of Acreage Data from the US Farm Service Agency"
author: C Alex Pellett
date: '`r Sys.Date()`' 
output: 
  word_document:
    number_sections: true
always_allow_html: true
---

```{r echo=F, message=F, warning=F}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
library(tidyverse)
library(magrittr)
library(readxl)
```

_"Farm Service Agency policy requires that producers participating in several programs submit an annual report regarding all cropland use on their farms. These programs include Agriculture Risk Coverage (ARC) and Price Loss Coverage (PLC). Reporting also applies to those who receive marketing assistance loans or loan deficiency payments. Failure to file an accurate and timely acreage report for all crops and land uses can result in loss of program benefits. Producers are required to self report all cropland on each farm to FSA annually. FSA uses these data to determine payment eligibility (land must be in an eligible agricultural use to qualify for payments) and to calculate losses for various disaster programs. Data are reported in the following categories: planted; prevented planted; and failed. In addition, the National Agricultural Statistics Service uses FSA planted acreage data to complement their survey data."_
https://www.fsa.usda.gov/news-room/efoia/electronic-reading-room/frequently-requested-information/crop-acreage-data/index

This memorandum documents the compilation of the Farm Service Agency data in to an R package. The goal is to maintain the data integrity, enhance comparability of the data over time, and reduce file size and read speed. Additional data validation is documented in a subsequent memorandum, "

```{r}
## Consider putting this function in the R folder, as part of the package.
## or as part of another package if it is generally useful.
## A function to track object.size, nrow, & ncol
## Add runtime to log.
## (color by col type? stripe width by col size?)
track_dataset <- function(df, step_name=NA_character_,
                          track_log='data_manipulation_log', step_inc=1 ) {
  track_log_entry <- list(step_name=step_name, step_inc=step_inc,
                          nrow=nrow(df), ncol=ncol(df), object.size=object.size(df)[1])
  if (exists(track_log)) {
    track_log_entry$.data <- get(track_log)
    track_log1 <- do.call(add_row, track_log_entry)
  } else {
    track_log1 <- as.data.frame(track_log_entry, stringsAsFactors=FALSE)
  }
  assign(track_log, track_log1, globalenv())
  print(step_name)
  invisible(df)
  #### Todo: Time each step
}
```

## The early years, 2009 and 2010
Irrigation practice information is not included in the FSA data for these years. Also, some fields were labelled inconsistently. Columns "Irrigation Practice" and "State County Code" are created here for forward compatibility. In these tables, it appears that there is a row for each intended use of each crop on each farm. There are then columns for the planted acres, prevented acres, and failed acres. The tables are pivoted so that there is a row for each _type_ (planted, prevented, and failed) of acreage for each intended use of each crop on each farm. Then, rows with acreage values of 0 are removed.

```{r echo=F}
fsa0 <- bind_rows(
  `2009`=read_xlsx('downloaded excel files\\2009_fsa_acres_detail_final_7.xlsx') %>%
    rename(`State Abbrev`='State Name') %>% track_dataset('2009'),
  `2010`=read_xlsx('downloaded excel files\\2010_fsa_acres_detail_final_5.xlsx') %>%
    rename(`State Code`=State) %>% track_dataset('2010'),
  .id='Year') %>% track_dataset('fsa0') %>%
  mutate(`Irrigation Practice`='T',
         `State County Code`= paste0(`State Code`, `County Code`)) %>%
  gather('Type', 'Acres', `Planted Acres`:`Failed Acres`) %>%
  mutate(Type = gsub("\\s*\\w*$", "", Type)) %>%
  track_dataset('fsa0 tidy') %>%
  filter(Acres != 0 & !is.na(Acres)) %>%
  track_dataset('fsa0 filter 0s') ## 310,076 obs of 14 variables. 35,177,520 bytes
```


## A Transition Year, 2011
The FSA acreage data for 2011 includes irrigation practice, but is formatted differently from the subsequent years. Now, in addition to acreage types of Planted, Prevented, and Failed, there are additional types of Volunteer, Plant and Fail, and Not Planted. Further, each of these types is either irrigated or not, so there are many types of acreage. Also, there are columns for total acreage values: Planted Total, Prevented Total, Failed Total, Volunteer Total, Not Planted Total, and Plant and Fail Total. The values in the total columns are equal to the sum of the irrigated and nonirrigated acreage for each type.

```{r echo=F}
### I deleted some newlines in the column labels of 2011 by hand in excel.
fsa11 <- read_xlsx('downloaded excel files\\2011_fsa_acres_detail_jan2012.xlsx') %>%
  track_dataset('2011')

## 162,334 obs of 27 variables.

## Test input data before making assumptions:
## Do the total columns all add up correctly?
## If so, then I can safely remove some redundant data.
# fsa11b <- fsa11 %>% mutate(
#   PlantT=`Planted Irrigated` + `Planted Nonirrigated`,
#   PreventT = `Prevented Irrigated` + `Prevented Nonirrigated`,
#   FailT = `Failed Irrigated` + `Failed Nonirrigated`,
#   VolT = `Volunteer Irrigated` + `Volunteer Nonirrigated`,
#   NPlantT = `Not Planted Irrigated` + `Not Planted Nonirrigated`,
#   PandFT = `Plant and Fail Irrigated` + `Plant and Fail Nonirrigated`,
#   PandFI = `Planted Irrigated` + `Failed Irrigated`,
#   PandFN = `Planted Nonirrigated` + `Failed Nonirrigated`) %>%
#   mutate(
#     PlantTotalTest = PlantT-`Planted Total`,
#     PreventTotalTest = PreventT-`Prevented Total`,
#     FailTotalTest = FailT-`Failed Total`,
#     VolunteerTotalTest = VolT-`Volunteer Total`,
#     NotPlantedTotalTest = NPlantT-`Not Planted Total`,
#     PlantedFailedTotalTest = PandFT-`Plant and Fail Total`,
#     PandFIrrigatedTest = PandFI-`Plant and Fail Irrigated`,
#     PandFNonTest = PandFN-`Plant and Fail Nonirrigated`)
#
# summary(fsa11b[,36:43])
# # filter(fsa11b, PlantedFailedTotalTest != 0) %>% View()
# all.equal(fsa11b$`Plant and Fail Total`, fsa11b$PandFT)
# ## it checks out.
# rm(fsa11b)
```
The _type_ columns are pivoted to rows, and the zero values are removed. The nonirrigated acreage values are unnecessary (because the irrigated acreage and the total acreage provide that information). 

```{r echo=F}
### Could remove the acreage totals, but I want to plot those values.
### Instead, remove the nonirrigated acreages, and also the plant-and-fail sums.
### Gather the remaining acreage types in to 2 columns: Type & Acres
### Create 'Irrigation Practice' column from the Type column,
### Trim the last word from each Type entry
fsa11b <- select(fsa11, # -`Crop Type`,
                -`Planted Nonirrigated`, -`Prevented Nonirrigated`,-`Failed Nonirrigated`,
                -`Volunteer Nonirrigated`, -`Not Planted Nonirrigated`,-`Plant and Fail Nonirrigated`,
                -`Plant and Fail Total`, -`Plant and Fail Irrigated`) %>%
  track_dataset('fsa11 remove nonirrigated') %>%
  gather('Type', 'Acres', `Planted Total`:`Not Planted Irrigated`) %>%
  track_dataset('fsa11 gather type') %>%
  mutate(`Irrigation Practice` = if_else(Type %in% c(
    'Planted Irrigated', 'Prevented Irrigated', 'Failed Irrigated',
    'Volunteer Irrigated', 'Not Planted Irrigated'), 'I', 'T'),
    `State County Code`= paste0(`State Code`, `County Code`),
    Year='2011') %>%
  track_dataset('fsa11 add irrigated practice') %>%
  mutate(Type = gsub("\\s*\\w*$", "", Type)) %>%
  filter(Acres != 0 & !is.na(Acres)) %>%
  track_dataset('fsa11 filter missing data')
## 232618 obs. of 14 variables.
```

## State Names and Abbreviations
There is some variation in the spelling or capitalization of the State names and abbreviations between the 2009-2010 data and the 2011 data. Fortunately, there are numeric codes for the states, and so the codes are used to standardize the State names and abbreviations.
```{r}
#### Create State_table to help clean-up
## variable spellings of states or abbreviations
State_table <-
  full_join(
    select(fsa11b, `State Code`, `State Name`) %>% unique(),
    select(fsa0, `State Code`, `State Abbrev`) %>% unique()) %>%
  mutate(`State Name`=if_else(`State Abbrev`=='MP', 'MARIANA ISLANDS', `State Name`))

fsa1 <- bind_rows(fsa0, fsa11b) %>%
  select(-`State Name`, -`State Abbrev`) %>%
  left_join(State_table) %>% track_dataset('fsa1')
## 542,694 obs. of 15 variables. 65,605,208 bytes

# all.equal(fsa1[,c('State Code', 'State Name', 'State Abbrev')] %>% unique(),
#           State_table) ## TRUE
## This checks out...

rm(fsa0, fsa11, fsa11b)
```

## 2012-present: consistent files
The remaining files are more uniform.
```{r}
read_fsa <- function(x) {
  read_xlsx(x, sheet='county_data') %>%
    select(-`Planted and Failed Acres`) %>%
    filter(!is.na(County))}

fsa2 <- bind_rows(
  `2012`=read_fsa('downloaded excel files\\2012_fsa_acres_jan_2013.xlsx') %>%
    rename(`Failed Acres`='Failded Acres') %>% track_dataset('2012'),
  `2013`=read_fsa('downloaded excel files\\2013_fsa_acres_jan_2014.xlsx') %>% track_dataset('2013'),
  `2014`=read_fsa('downloaded excel files\\2014_fsa_acres_jan2014.xlsx') %>% track_dataset('2014'),
  `2015`=read_fsa('downloaded excel files\\2015_fsa_acres_01052016.xlsx') %>% track_dataset('2015'),
  `2016`=read_fsa('downloaded excel files\\2016_fsa_acres_010417.xlsx') %>% track_dataset('2016'),
  `2017`=read_fsa('downloaded excel files\\2017_fsa_acres_010418.xlsx') %>% track_dataset('2017'),
  `2018`=read_fsa('downloaded excel files\\2018_fsa_acres_012819.xlsx') %>% track_dataset('2018'),
  `2019`=read_fsa('downloaded excel files\\2019_fsa_acres_web_010220.xlsx') %>% track_dataset('2019'),
  `2020`=read_fsa('downloaded excel files\\2020_fsa_acres_web_010521.xlsx') %>% track_dataset('2020'),
  `2021`=read_fsa('downloaded excel files\\2021_fsa_acres_web_080221.xlsx') %>% track_dataset('2021'),
  .id='Year')  %>% track_dataset('fsa2012-2021') ## 1,790,332 obs of 16 variables. 158,999,384 bytes
```

```{r}
## calculate Total acres, make tidy
fsa2b <- fsa2 %>%
  gather('Type', 'Acres', `Planted Acres`:`Not Planted Acres`) %>% ## 6,189,540 obs. of 13 variables. 644,259,288 bytes
  track_dataset('fsa2 gather acreage types') %>%
  group_by(`State Code`, County, `County Code`, `State County Code`, Year,
                  `Crop`, `Crop Type`, `Crop Code`, `Intended Use`, `Irrigation Practice`, `Type`) %>%
  summarise(Acres=sum(Acres, na.rm=TRUE)) %>%
  ungroup() %>%
  track_dataset('fsa2 sum acres by county, crop, use, irrigation, and type') %>%
  spread(`Irrigation Practice`, Acres) %>%
  mutate(Type = gsub("\\s*\\w*$", "", Type),
         I= if_else(is.na(I), 0, I),
         N= if_else(is.na(N), 0, N),
         O= if_else(is.na(O), 0, O)) %>%
  mutate(`T`=I+N+O) %>% select(-N) %>%
  track_dataset('fsa2 spread irrigation practice, calculate total, remove unirrigated') %>%
  gather(`Irrigation Practice`, 'Acres', `I`:`T`) %>%
  track_dataset('fsa2 gather irrigation practice') %>%
  filter(Acres != 0 & !is.na(Acres)) %>% ## 1522162
  track_dataset("fsa2 remove 0's and missing data") %>%
  rename(`County Name`=County, `Crop Type Name`='Crop Type', `Crop Name`=Crop)

State_table[55,] <- list("60","AMERICAN SAMOA", "AS")
fsa2b <- inner_join(fsa2b, State_table) %>% track_dataset('fsa2 state join')
```
The types of acreage values, such as Planted Acres, Failed Acres, etc., which are listed in separate columns in the raw tables, are separated in to distinct rows. Then the acreage values are summed for each year, county, crop, crop type, intended use, irrigation practice, and type. Prior to that operation, each row represented a specific (though unnamed) farm, now the rows represent the totals for the county. The rows for nonirrigated acreage are removed, because that information is implicit in the values for irrigated and total acreage. 



```{r}
fsa <- bind_rows(fsa1, fsa2b) %>% track_dataset('fsa')
saveRDS(fsa, 'acresFSA_compilation.rds')
rm(fsa1, fsa2, fsa2b)

write.csv(data_manipulation_log, 'data_compilation_log.csv')

### TODO!!!: Read in farm counts
# read_farm_count <- function(x) {read_xlsx(x, sheet='farm_count')}

```

